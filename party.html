<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>聚会点 · 近邻中心 · 高德地图</title>
    <!-- Font Awesome 6 (免费) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #f0f4f8;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        /* 顶部工具栏 */
        .toolbar {
            background: white;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.8rem 1.2rem;
            border-bottom: 1px solid #e9ecf0;
            z-index: 10;
        }
        .toolbar .title {
            font-weight: 600;
            color: #1e3c72;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 0.5rem;
        }
        .title i {
            color: #3b7cbf;
        }
        .btn {
            background: #f5f9ff;
            border: 1px solid #ccdae8;
            padding: 0.5rem 1.2rem;
            border-radius: 30px;
            font-size: 0.95rem;
            font-weight: 500;
            color: #1e3c72;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            -webkit-tap-highlight-color: transparent; /* 移除移动端点击高亮 */
        }
        .btn i {
            font-size: 1rem;
            color: #2b5f9e;
        }
        .btn:hover {
            background: #e3edfc;
            border-color: #8fb6e0;
            box-shadow: 0 4px 8px rgba(0,60,120,0.1);
        }
        .btn:active {
            transform: scale(0.97);
        }
        .btn.accent {
            background: #1e3c72;
            border-color: #0f2645;
            color: white;
        }
        .btn.accent i {
            color: white;
        }
        .btn.accent:hover {
            background: #2a4b8a;
        }
        .coord-output {
            background: #eef3fa;
            padding: 0.4rem 1rem;
            border-radius: 40px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            flex-wrap: wrap;
            border: 1px solid #b9cee8;
        }
        .coord-output span {
            font-weight: 600;
            color: #0a2a44;
        }
        .coord-output i {
            color: #c44536;
            margin-right: 4px;
        }
        .badge {
            background: #d4e0f0;
            border-radius: 20px;
            padding: 0.2rem 1rem;
            font-size: 0.85rem;
            color: #1a3e6f;
        }
        /* 地图容器 */
        #mapContainer {
            flex: 1;
            width: 100%;
            background: #cbd8e6;
            position: relative;
        }
        /* 右侧/底部坐标面板 (悬浮卡片) */
        .list-panel {
            position: absolute;
            bottom: 24px;
            right: 20px;
            width: 300px;
            max-width: calc(100% - 40px);
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(4px);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0,20,50,0.25);
            border: 1px solid rgba(255,255,255,0.6);
            padding: 1rem 0.8rem 1rem 1rem;
            z-index: 100;
            transition: 0.2s;
        }
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0.5rem 0.5rem 0.5rem;
            border-bottom: 1px solid #dde3ec;
            font-weight: 600;
            color: #19355b;
        }
        .list-header i {
            color: #2f6bb0;
        }
        .participant-list {
            list-style: none;
            max-height: 220px;
            overflow-y: auto;
            margin: 0.5rem 0 0.2rem;
            padding-right: 5px;
            -webkit-overflow-scrolling: touch; /* 流畅滚动 */
        }
        .participant-list li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafd;
            margin: 6px 0;
            padding: 8px 12px;
            border-radius: 40px;
            font-size: 0.85rem;
            border: 1px solid #dbe3ef;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .coord-text {
            font-family: 'JetBrains Mono', monospace;
            background: #e9f0f9;
            padding: 2px 8px;
            border-radius: 30px;
            color: #113355;
            font-size: 0.8rem;
        }
        .delete-point {
            background: none;
            border: none;
            color: #9a7b6b;
            cursor: pointer;
            font-size: 1.2rem; /* 增大点击区域 */
            padding: 8px;
            border-radius: 50%;
            transition: all 0.15s;
            line-height: 1;
            -webkit-tap-highlight-color: transparent;
        }
        .delete-point:hover {
            background: #f6d5d0;
            color: #b3412c;
        }
        .empty-message {
            color: #7a8ca0;
            font-style: italic;
            text-align: center;
            padding: 12px 0;
            font-size: 0.9rem;
        }
        .footer-note {
            font-size: 0.75rem;
            color: #778ea8;
            margin-top: 6px;
            text-align: right;
            border-top: 1px dashed #cbd6e6;
            padding-top: 6px;
        }
        /* 提示小标签 */
        .map-tip {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(25, 45, 70, 0.8);
            backdrop-filter: blur(8px);
            color: white;
            padding: 0.4rem 1.6rem;
            border-radius: 60px;
            font-size: 0.9rem;
            z-index: 50;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        .map-tip i {
            margin-right: 6px;
            color: #ffd966;
        }
        /* 重置按钮小图标 */
        .fa-rotate-right {
            transition: transform 0.3s;
        }
        .btn:hover .fa-rotate-right {
            transform: rotate(30deg);
        }

        /* ---------- 手机端适配 (max-width: 600px) ---------- */
        @media (max-width: 600px) {
            .toolbar {
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
            }
            .toolbar .title {
                font-size: 1rem;
                margin-right: 0.2rem;
            }
            .btn {
                padding: 0.4rem 0.9rem;
                font-size: 0.85rem;
                gap: 4px;
            }
            .btn i {
                font-size: 0.9rem;
            }
            .coord-output {
                padding: 0.3rem 0.8rem;
                font-size: 0.8rem;
                margin-left: 0;  /* 在小屏幕上不再右对齐 */
                width: 100%;      /* 强制换行占满 */
                order: 2;         /* 放到按钮后面 */
                justify-content: center;
            }
            .badge {
                font-size: 0.75rem;
                padding: 0.15rem 0.7rem;
            }
            /* 悬浮列表改为底部通栏样式 */
            .list-panel {
                left: 10px;
                right: 10px;
                bottom: 10px;
                width: auto;
                max-width: none;
                border-radius: 20px;
                padding: 0.8rem 0.6rem 0.8rem 0.8rem;
            }
            .participant-list {
                max-height: 180px; /* 略微降低高度 */
            }
            .list-header {
                font-size: 0.9rem;
            }
            .participant-list li {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            .coord-text {
                font-size: 0.75rem;
            }
            .delete-point {
                font-size: 1.1rem;
                padding: 6px;
            }
            .footer-note {
                font-size: 0.7rem;
            }
            .map-tip {
                font-size: 0.75rem;
                padding: 0.3rem 1.2rem;
                top: 8px;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
<div id="app">
    <!-- 工具栏 -->
    <div class="toolbar">
        <div class="title"><i class="fas fa-people-arrows"></i> 聚会点</div>
        <button class="btn" id="computeBtn"><i class="fas fa-calculator"></i> 计算</button>
        <button class="btn" id="clearBtn"><i class="fas fa-trash-alt"></i> 清空</button>
        <button class="btn" id="resetViewBtn"><i class="fas fa-rotate-right"></i> 重置</button>
        <div class="coord-output" id="partyCoordDisplay">
            <i class="fas fa-location-dot"></i>
            <span>聚会点:</span>
            <span id="partyCoords">——</span>
        </div>
        <div class="badge" id="countBadge"><i class="far fa-user"></i> 0 人</div>
    </div>

    <!-- 地图容器 -->
    <div id="mapContainer"></div>
    
    <!-- 悬浮列表 (参与者坐标) -->
    <div class="list-panel">
        <div class="list-header">
            <span><i class="fas fa-map-pin" style="margin-right:6px;"></i>已选位置</span>
            <span style="font-size:0.8rem; background:#e3ecf5; padding:2px 8px; border-radius:20px;">点击地图添加</span>
        </div>
        <ul class="participant-list" id="participantList">
            <li class="empty-message">暂无坐标，请在地图上点选</li>
        </ul>
        <div class="footer-note">
            <i class="fas fa-info-circle"></i> 聚会点 = 平均坐标 (几何中心)
        </div>
    </div>

    <!-- 地图中央提示 -->
    <!-- <div class="map-tip">
        <i class="fas fa-hand-pointer"></i> 点击地图添加位置
    </div> -->
</div>

<!-- 高德地图 JS API (2.0) 请替换 YOUR_KEY 为有效密钥 -->
<script src="https://webapi.amap.com/maps?v=2.0&key=bfd5663d98820f5385a400a829316988&callback=initMap"></script>
<!-- 安全密钥配置 (可选, 防止盗用, 这里仅作示例) -->
<script>
    window._AMapSecurityConfig = {
        securityJsCode: '你的高德安全代码',  // 如果有安全码，请替换，也可以直接在key后台设置域名白名单
    };
</script>

<script>
    (function() {
        // 等待高德API回调
        let map = null;
        // 存储参与者: 数组元素为 { marker: AMap.Marker, lng: number, lat: number }
        let participants = [];
        // 聚会点 marker (唯一)
        let partyMarker = null;
        // 地图默认中心: 南昌 (滕王阁附近)
        const NANCHANG_CENTER = [115.857, 28.682];
        const DEFAULT_ZOOM = 12;

        // DOM 元素
        const partyCoordSpan = document.getElementById('partyCoords');
        const participantListEl = document.getElementById('participantList');
        const countBadge = document.getElementById('countBadge');
        const computeBtn = document.getElementById('computeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resetViewBtn = document.getElementById('resetViewBtn');

        // 辅助函数: 创建自定义图标DOM (FontAwesome)
        function createIconElement(iconClass, color = '#e03a3a', size = 34) {
            const div = document.createElement('div');
            div.style.width = size + 'px';
            div.style.height = size + 'px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.fontSize = (size * 0.75) + 'px'; // 图标适当缩放
            div.style.color = color;
            div.style.textShadow = '0 2px 4px rgba(0,0,0,0.15)';
            div.style.background = 'transparent';
            div.innerHTML = `<i class="${iconClass}"></i>`;
            return div;
        }

        // 创建参与者 marker (使用offset使底部中心对准坐标点)
        function createParticipantMarker(lng, lat, color = '#d93f21') {
            const iconContent = createIconElement('fas fa-map-marker-alt', color, 34);
            const marker = new AMap.Marker({
                position: [lng, lat],
                content: iconContent,
                offset: new AMap.Pixel(-17, -34), // 宽度一半向左移，高度整个向上移 -> 底部中心对准
                zIndex: 10
            });
            return marker;
        }

        // 创建聚会点 marker (不同颜色图标)
        function createPartyMarker(lng, lat) {
            const iconContent = createIconElement('fas fa-flag-checkered', '#2b6c9e', 38);
            const marker = new AMap.Marker({
                position: [lng, lat],
                content: iconContent,
                offset: new AMap.Pixel(-19, -38), // 38/2=19，38向上
                zIndex: 20
            });
            return marker;
        }

        // 移除聚会点marker
        function removePartyMarker() {
            if (partyMarker) {
                partyMarker.destroy();
                partyMarker = null;
            }
        }

        // 刷新参与者列表UI
        function renderParticipantList() {
            if (!participantListEl) return;
            const len = participants.length;
            countBadge.innerHTML = `<i class="far fa-user"></i> ${len} 人`;

            if (len === 0) {
                participantListEl.innerHTML = '<li class="empty-message">暂无坐标，请在地图上点选</li>';
                return;
            }

            let htmlStr = '';
            participants.forEach((p, idx) => {
                const lngStr = p.lng.toFixed(6);
                const latStr = p.lat.toFixed(6);
                htmlStr += `<li>
                    <span style="display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-location-dot" style="color:#d93f21; font-size:0.9rem;"></i>
                        <span class="coord-text">${lngStr}, ${latStr}</span>
                    </span>
                    <button class="delete-point" data-index="${idx}" title="移除该点"><i class="fas fa-times-circle"></i></button>
                </li>`;
            });
            participantListEl.innerHTML = htmlStr;
        }

        // 根据participants更新聚会点显示(若无聚会点则显示'——')
        function updatePartyDisplay(computedLng = null, computedLat = null) {
            if (computedLng !== null && computedLat !== null) {
                partyCoordSpan.innerText = `${computedLng.toFixed(6)}, ${computedLat.toFixed(6)}`;
            } else {
                partyCoordSpan.innerText = '——';
            }
        }

        // 清除所有参与者以及聚会点
        function clearAllParticipants() {
            // 销毁所有参与者marker
            participants.forEach(p => {
                if (p.marker) p.marker.destroy();
            });
            participants = [];
            removePartyMarker();
            renderParticipantList();
            updatePartyDisplay();  // 清空显示
        }

        // 删除单个参与者 (通过索引)
        function removeParticipantByIndex(index) {
            if (index >= 0 && index < participants.length) {
                const p = participants[index];
                if (p.marker) p.marker.destroy();
                participants.splice(index, 1);
                // 点集合变动，聚会点失效，移除它
                removePartyMarker();
                renderParticipantList();
                updatePartyDisplay();  // 聚会点消失
            }
        }

        // 计算平均坐标 (几何中心)
        function computeAverageCenter() {
            if (participants.length === 0) return null;
            let sumLng = 0, sumLat = 0;
            participants.forEach(p => {
                sumLng += p.lng;
                sumLat += p.lat;
            });
            return {
                lng: sumLng / participants.length,
                lat: sumLat / participants.length
            };
        }

        // 计算并显示聚会点 (平均坐标)
        function computeAndShowParty() {
            if (participants.length === 0) {
                alert('至少添加一个坐标才能计算聚会点');
                return;
            }
            const center = computeAverageCenter();
            if (!center) return;

            // 移除旧的聚会点标记
            removePartyMarker();

            // 创建新的聚会点标记
            partyMarker = createPartyMarker(center.lng, center.lat);
            partyMarker.setMap(map);  // 添加到地图

            // 更新界面显示
            updatePartyDisplay(center.lng, center.lat);
        }

        // 重置地图视图到南昌
        function resetMapView() {
            if (map) {
                map.setCenter(NANCHANG_CENTER);
                map.setZoom(DEFAULT_ZOOM);
            }
        }

        // 初始化地图及事件
        window.initMap = function() {
            map = new AMap.Map('mapContainer', {
                center: NANCHANG_CENTER,
                zoom: DEFAULT_ZOOM,
                viewMode: '2D',   // 2D 或 3D
                pitch: 0,
                expandZoomRange: true,
                zooms: [4, 20]
            });

            // 可选添加比例尺、工具条，但不必须
            AMap.plugin(['AMap.ToolBar'], function() {
                map.addControl(new AMap.ToolBar({ position: 'RT' }));
            });

            // 地图点击事件：添加参与者
            map.on('click', function(e) {
                const { lng, lat } = e.lnglat;
                // 创建参与者marker
                const marker = createParticipantMarker(lng, lat);
                marker.setMap(map);
                // 存储
                participants.push({ marker, lng, lat });
                // 新加点导致之前的聚会点失效 (因为人群变了)
                removePartyMarker();
                // 更新列表
                renderParticipantList();
                updatePartyDisplay();  // 清空聚会点坐标显示
            });

            // 初始化列表
            renderParticipantList();
        };

        // 等待DOM加载完成，绑定按钮事件 (地图异步已由callback触发)
        document.addEventListener('DOMContentLoaded', function() {
            // 计算按钮
            computeBtn.addEventListener('click', function() {
                computeAndShowParty();
            });

            // 清空坐标
            clearBtn.addEventListener('click', function() {
                clearAllParticipants();
            });

            // 重置视图
            resetViewBtn.addEventListener('click', function() {
                resetMapView();
            });

            // 列表内删除事件 (事件委托)
            participantListEl.addEventListener('click', function(e) {
                const target = e.target.closest('.delete-point');
                if (target && target.dataset.index !== undefined) {
                    const idx = parseInt(target.dataset.index, 10);
                    if (!isNaN(idx)) {
                        removeParticipantByIndex(idx);
                    }
                }
            });
        });

        // 如果高德key无效或未设置，提醒用户
        window.onerror = function(msg) {
            if (msg.includes('AMap') || msg.includes('高德')) {
                alert('高德地图加载失败，请检查KEY配置。您需要替换 script 中的 YOUR_KEY 为有效的高德JS API Key。');
            }
        };
    })();
</script>

<!-- 说明：请将高德地图密钥替换为您的有效key (在script src中) -->
</body>
</html>